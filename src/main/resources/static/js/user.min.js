const userId=Array.from(document.documentURI.split("/")).at(-1),commentsElem=document.getElementById("commentsList");let commentTemplate='<hr class="my-0" /><div class="card-body p-4">\n                          <div class="d-flex flex-start">\n                            <img class="rounded-circle shadow-1-strong me-3 comment-user-avatar"\n                                 src="%avatar%" alt="User Avatar" />\n                            <div>\n                              <h6 class="fw-bold mb-1 comment-username">%username%</h6>\n                              <div class="d-flex align-items-center mb-3 comment-buttons" commentId=\'%commentId%\'>\n                                <p class="mb-0 comment-date">%date%</p>\n                                                       %editBtn%         \n                                                       %deleteBtn%         \n                              </div>\n                              <p class="mb-0 comment-text">%text%</p>\n                            </div>\n                          </div>\n                        </div>',deleteTemplate='<a class="comment-delete" onclick="deleteComment(this)" data-bs-toggle="tooltip" title="'+delText+'">\n                                  <i class="bi bi-trash3 ms-2"></i>\n                                </a>',editTemplate='<a class="comment-edit" onclick="editComment(this)" data-bs-toggle="tooltip" title="'+edit+'">\n                                  <i class="bi bi-pencil-square ms-2"></i>\n                                </a>',editCommentTemplate='<input type="text" id="editComment" class="form-control" value="%text%" />',editedTextTemplate="<span class='mb-0 text-muted comment-edited'>"+editedText+"</span>",evtSource=new EventSource("/sse/subscribe/comments");function editComment(e){let t=e.parentElement.parentElement,n=t.getElementsByClassName("comment-text")[0],a=editCommentTemplate.replace("%text%",n.textContent),m=n.textContent;t.removeChild(n),t.insertAdjacentHTML("beforeend",a);let l=document.getElementById("editComment"),s=$(l).val().length;l.focus(),l.setSelectionRange(s,s),$("#editComment").on("keydown",function e(a){let l=$(this).parent().find(".comment-buttons"),s=$(this).val();if(13==a.keyCode||"focusout"==a){if(m!=s){sendEditComment(l.attr("commentId"),s),n.textContent=$(this).val();let o=$(t).find(".comment-date"),i=new Date($.now()).toISOString(),d=i.split("T")[0].split("-"),c=i.split("T")[1].split(".")[0].split(":"),r=Number(c[0])+3,p=d[2]+"."+d[1]+"."+d[0]+" "+r+":"+c[1];$(o).html(p+" "+editedTextTemplate)}t.removeChild(document.getElementById("editComment")),t.insertAdjacentHTML("beforeend",n.outerHTML)}})}function sendEditComment(e,t){$.ajax({type:"POST",url:"/users/comments?commentId="+e,data:t,cache:!1,contentType:!1,processData:!1})}function deleteComment(e){$.ajax({type:"DELETE",url:"/users/comments?commentId="+$(e).parent().attr("commentId"),cache:!1,contentType:!1,processData:!1})}evtSource.addEventListener("createComment",function(e){let t=JSON.parse(e.data);if(t.userId!=userId)return;let n;n=null!=t.avatar?"data:image;base64,"+t.avatar:"/static/img/default_avatar.png";let a=t.date.split("T")[0].split("-"),m=t.date.split("T")[1].split(".")[0].split(":"),l=a[2]+"."+a[1]+"."+a[0]+" "+m[0]+":"+m[1],s=commentTemplate.replace("%username%",t.username).replace("%commentId%",t.id).replace("%text%",t.text).replace("%date%",l).replace("%avatar%",n);s=null!=principalId&&t.authorId==principalId?s.replace("%editBtn%",editTemplate).replace("%deleteBtn%",deleteTemplate):s.replace("%editBtn%","").replace("%deleteBtn%",""),commentsElem.insertAdjacentHTML("beforeend",s);[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e){return new bootstrap.Tooltip(e)})}),evtSource.addEventListener("editComment",function(e){let t=JSON.parse(e.data);t.userId==userId&&Array.from(commentsElem.getElementsByClassName("comment-buttons")).forEach(e=>{if(e.getAttribute("commentId")==t.commentId){let n=e.parentElement.getElementsByClassName("comment-text")[0],a=t.date.split("T")[0].split("-"),m=t.date.split("T")[1].split(".")[0].split(":"),l;$(e.getElementsByClassName("comment-date")[0]).html(a[2]+"."+a[1]+"."+a[0]+" "+m[0]+":"+m[1]+" "+editedTextTemplate),$(n).text(t.text)}})}),evtSource.addEventListener("deleteComment",function(e){let t=JSON.parse(e.data);t.userId==userId&&Array.from(commentsElem.getElementsByClassName("comment-buttons")).forEach(e=>{if(e.getAttribute("commentId")==t.commentId){let n=e.parentElement.parentElement.parentElement;null!=n.previousElementSibling&&"HR"==n.previousElementSibling.tagName&&commentsElem.removeChild(n.previousSibling);let a=$(e).find(".comment-delete");null!=a&&$(a).tooltip("hide"),commentsElem.removeChild(n)}})}),$(document).ready(function(){if(0!=commentsList.length){Array.from(commentsList).forEach(e=>{let t;t=null!=e.authorAvatar?"data:image;base64,"+e.authorAvatar:"/static/img/default_avatar.png";let n=e.commentedAt.split("T")[0].split("-"),a=e.commentedAt.split("T")[1].split(".")[0].split(":"),m=n[2]+"."+n[1]+"."+n[0]+" "+a[0]+":"+a[1],l="";e.edited&&(l=editedTextTemplate);let s=commentTemplate.replace("%username%",e.user.username).replace("%text%",e.text).replace("%commentId%",e.id).replace("%date%",m+" "+l).replace("%avatar%",t);s=null!=principalId&&e.authorId==principalId?s.replace("%editBtn%",editTemplate).replace("%deleteBtn%",deleteTemplate):s.replace("%editBtn%","").replace("%deleteBtn%",""),commentsElem.insertAdjacentHTML("beforeend",s)});[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e){return new bootstrap.Tooltip(e)})}}),evtSource.onerror=function(e){switch(this.readyState){case EventSource.CONNECTING:break;case EventSource.CLOSED:evtSource=new EventSource("/sse/subscribe/comments")}},$("#addComment").on("keydown",function e(t){if(13==t.keyCode){let n=$(this).val();$.ajax({type:"PUT",url:"/users/comments?userId="+userId,data:n,cache:!1,contentType:!1,processData:!1}),$(this).val("")}});